<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üåø Mapa de Vegetaci√≥n (NDVI) ‚Äî √öltima imagen disponible</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script src="https://unpkg.com/esri-leaflet@3/dist/esri-leaflet.js" crossorigin></script>
  <style>
    :root{--bg:#0f1430;--panel:#0b1030;--text:#e8ecff;--muted:rgba(255,255,255,.75);--verylow:#bd7c5d;--low:#cca828;--mid:#e2e90c;--high:#408b6d;--veryhigh:#0a544a;--null:#7b8696}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial;background:#0a0f24}
    header{position:sticky;top:0;z-index:1000;padding:.6rem .9rem;background:var(--bg);color:var(--text);border-bottom:1px solid rgba(255,255,255,.12);display:flex;justify-content:space-between;align-items:center;gap:.8rem}
    .controls{display:flex;gap:.5rem;align-items:center}
    .controls select,.controls input{background:var(--panel);color:var(--text);border:1px solid rgba(255,255,255,.2);border-radius:.5rem;padding:.35rem .5rem}
    #map{height:calc(100vh - 56px)}
    .legend{position:absolute;right:12px;bottom:12px;background:rgba(15,20,48,.92);color:var(--text);padding:.6rem .7rem;border:1px solid rgba(255,255,255,.18);border-radius:.6rem;font-size:.85rem;z-index:2000;box-shadow:0 6px 18px rgba(0,0,0,.3);pointer-events:none;min-width:260px}
    .bar{height:10px;width:100%;background:linear-gradient(90deg,var(--verylow) 0%,var(--verylow) 20%,var(--low) 20%,var(--low) 40%,var(--mid) 40%,var(--mid) 60%,var(--high) 60%,var(--high) 80%,var(--veryhigh) 80%,var(--veryhigh) 100%);border-radius:999px;margin:.45rem 0}
    .scale{display:flex;justify-content:space-between;opacity:.9}
    .status{position:absolute;left:12px;bottom:12px;background:rgba(15,20,48,.92);color:var(--text);padding:.35rem .55rem;border:1px solid rgba(255,255,255,.18);border-radius:.6rem;font-size:.85rem;z-index:2000;box-shadow:0 6px 18px rgba(0,0,0,.3);pointer-events:none}
    .chip{display:inline-block;width:14px;height:10px;border-radius:2px}
  </style>
</head>
<body>
  <header>
    <div>
      <strong>Vegetaci√≥n (NDVI coloreado)</strong><br>
      <small style="color:var(--muted)">√öltima imagen disponible. Fuentes: Landsat 8/9 (USGS/NASA) y Sentinel‚Äë2 (ESA) v√≠a Esri ImageServer.</small>
    </div>
    <div class="controls">
      <label for="dataset"><small>Dataset</small></label>
      <select id="dataset">
        <option value="landsat" selected>Landsat 8/9</option>
        <option value="sentinel">Sentinel‚Äë2</option>
      </select>
      <label for="search"><small>Buscar</small></label>
      <input id="search" type="text" placeholder="Ej: Valdivia, Chile" list="suggestions"/>
      <datalist id="suggestions"></datalist>
    </div>
  </header>

  <div id="map"></div>

  <div class="legend">
    <div><strong>NDVI ‚Üí Probabilidad de floraci√≥n</strong></div>
    <div class="bar"></div>
    <div class="scale"><span>Bajo</span><span>Alto</span></div>
    <div style="margin-top:.45rem;line-height:1.2">
      <div><span class="chip" style="background:var(--null)"></span><small>Nula (√Årtico/Ant√°rtico)</small></div>
      <div><span class="chip" style="background:var(--verylow)"></span><small>Muy baja (&lt; 0.10)</small></div>
      <div><span class="chip" style="background:var(--low)"></span><small>Baja (0.10‚Äì0.30)</small></div>
      <div><span class="chip" style="background:var(--mid)"></span><small>Media (0.30‚Äì0.50)</small></div>
      <div><span class="chip" style="background:var(--high)"></span><small>Alta (0.50‚Äì0.70)</small></div>
      <div><span class="chip" style="background:var(--veryhigh)"></span><small>Muy alta (‚â• 0.70)</small></div>
    </div>
  </div>

  <div class="status" id="status">Cargando‚Ä¶</div>

  <script>
    // Configuraci√≥n optimizada
    const SERVICES = {
      landsat: 'https://landsat2.arcgis.com/arcgis/rest/services/Landsat8_Views/ImageServer',
      sentinel: 'https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer'
    };
    
    // Mapeo de colores NDVI a valores (optimizaci√≥n por color)
    const COLOR_TO_NDVI = {
      '#7b8696': 0,     // Nula
      '#bd7c5d': 0.05,  // Muy baja
      '#cca828': 0.2,   // Baja  
      '#e2e90c': 0.4,   // Media
      '#408b6d': 0.6,   // Alta
      '#0a544a': 0.8    // Muy alta
    };

    // UI elementos
    const map = L.map('map').setView([-33.4489, -70.6693], 8);
    const statusEl = document.getElementById('status');
    const datasetSel = document.getElementById('dataset');
    const searchInput = document.getElementById('search');
    
    // Mapa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 13,
      attribution: '&copy; OpenStreetMap | Imagery: USGS/NASA & ESA via Esri'
    }).addTo(map);

    let currentDataset = 'landsat';
    let ndviLayer = null;
    let imageSvc = L.esri.imageService({ url: SERVICES[currentDataset] });
    let dragMarker = null;

    // Funci√≥n optimizada para identificar NDVI por color
    function identifyByColor(canvas, x, y) {
      const ctx = canvas.getContext('2d');
      const pixel = ctx.getImageData(x, y, 1, 1).data;
      const hex = '#' + [pixel[0], pixel[1], pixel[2]].map(x => x.toString(16).padStart(2, '0')).join('');
      
      // Buscar color m√°s cercano
      let closest = null;
      let minDist = Infinity;
      
      for (const [color, ndvi] of Object.entries(COLOR_TO_NDVI)) {
        const r1 = parseInt(color.slice(1, 3), 16);
        const g1 = parseInt(color.slice(3, 5), 16);
        const b1 = parseInt(color.slice(5, 7), 16);
        
        const dist = Math.sqrt(
          Math.pow(pixel[0] - r1, 2) + 
          Math.pow(pixel[1] - g1, 2) + 
          Math.pow(pixel[2] - b1, 2)
        );
        
        if (dist < minDist) {
          minDist = dist;
          closest = ndvi;
        }
      }
      
      return closest;
    }

    // Funci√≥n optimizada para identificar NDVI
    async function identifyNDVI(latlng) {
      return new Promise(resolve => {
        imageSvc.identify()
          .at(latlng)
          .setRenderingRule({ rasterFunction: 'NDVI Raw' })
          .run((err, res) => {
            if (err || !res) {
              resolve(null);
              return;
            }
            
            let value = null;
            if (res.value !== undefined) value = Number(res.value);
            else if (res.pixel?.value !== undefined) value = Number(res.pixel.value);
            else if (res.values?.length) value = Number(res.values[0]);
            
            resolve(value !== null && !isNaN(value) ? Math.max(0, Math.min(1, value)) : null);
          });
      });
    }

    // Predicci√≥n optimizada de floraci√≥n
    function predictFlowering(lat, lng, ndviValue) {
      const absLat = Math.abs(lat);
      
      // Zonas imposibles
      if (absLat > 80) return { label: 'Nula', color: '#7b8696', score: 0 };
      
      // Usar NDVI si est√° disponible
      if (ndviValue !== null) {
        if (ndviValue < 0.1) return { label: 'Muy baja', color: '#bd7c5d', score: ndviValue };
        if (ndviValue < 0.3) return { label: 'Baja', color: '#cca828', score: ndviValue };
        if (ndviValue < 0.5) return { label: 'Media', color: '#e2e90c', score: ndviValue };
        if (ndviValue < 0.7) return { label: 'Alta', color: '#408b6d', score: ndviValue };
        return { label: 'Muy alta', color: '#0a544a', score: ndviValue };
      }
      
      // Fallback clim√°tico simplificado
      let score = 0.2;
      if (absLat < 35) score = 0.35;
      if (absLat < 23.5) score = 0.4;
      
      if (score < 0.3) return { label: 'Baja', color: '#cca828', score };
      return { label: 'Media', color: '#e2e90c', score };
    }

    // Actualizar informaci√≥n del pin (optimizado)
    async function updatePin(latlng) {
      const coords = `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
      
      try {
        const ndviValue = await identifyNDVI(latlng);
        const prediction = predictFlowering(latlng.lat, latlng.lng, ndviValue);
        
        const html = `<b>Probabilidad de floraci√≥n:</b> <b style="color:${prediction.color}">${prediction.label}</b><br>` +
                     `<small>NDVI: ${ndviValue ? ndviValue.toFixed(2) : 'n/a'} | ${coords}</small>`;
        
        if (!dragMarker) {
          dragMarker = L.marker(latlng, { draggable: true }).addTo(map);
          dragMarker.on('dragend', (e) => updatePin(e.target.getLatLng()));
        } else {
          dragMarker.setLatLng(latlng);
        }
        
        dragMarker.bindPopup(html).openPopup();
        
      } catch (error) {
        console.error('Error updating pin:', error);
      }
    }

    // Aplicar capa NDVI (optimizado)
    function applyLayer() {
      if (ndviLayer) map.removeLayer(ndviLayer);
      
      const rfName = currentDataset === 'landsat' ? 'NDVI Colorized' : 'NDVI Colormap';
      
      ndviLayer = L.esri.imageMapLayer({
        url: SERVICES[currentDataset],
        renderingRule: { rasterFunction: rfName },
        opacity: 0.9
      }).addTo(map);
      
      ndviLayer.once('load', () => {
        statusEl.textContent = `NDVI cargado ‚Äî ${currentDataset}`;
      });
      
      ndviLayer.on('requesterror', () => {
        statusEl.textContent = 'Error cargando NDVI';
      });
    }

    // B√∫squeda optimizada
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      if (query.length < 3) return;
      
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`
          );
          const results = await response.json();
          
          if (results.length > 0) {
            const result = results[0];
            const latlng = L.latLng(parseFloat(result.lat), parseFloat(result.lon));
            map.setView(latlng, 12);
            updatePin(latlng);
          }
        } catch (error) {
          console.error('Search error:', error);
        }
      }, 500);
    });

    // Event listeners optimizados
    map.on('click', (e) => updatePin(e.latlng));
    
    datasetSel.addEventListener('change', () => {
      currentDataset = datasetSel.value;
      imageSvc = L.esri.imageService({ url: SERVICES[currentDataset] });
      applyLayer();
    });

    // Inicializaci√≥n
    applyLayer();
    setTimeout(() => updatePin(L.latLng(-33.4489, -70.6693)), 1000);
  </script>
</body>
</html>