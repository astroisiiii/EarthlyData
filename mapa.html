<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#07173F" />
  <title>EarthlyData üåç Mapa Global</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Overpass:wght@400;600;700&family=Fira+Sans:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Leaflet y MarkerClusterx -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3/dist/esri-leaflet.js"></script>

  <style>
    :root {
      --deep-blue: #07173F;
      --electric-blue: #0042A6;
      --neon-yellow: #EAFE07;
      --white: #FFFFFF;
      --gradient: linear-gradient(45deg, var(--electric-blue), var(--deep-blue));
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Fira Sans', sans-serif;
      background: var(--gradient);
      color: var(--white);
      padding-top: 80px;
    }
    /* NASA Space Apps: start */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: var(--deep-blue);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      border-bottom: 2px solid var(--electric-blue);
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .logo img {
      height: 40px;
      width: auto;
    }
    .logo h1 {
      font-family: 'Overpass', sans-serif;
      font-size: 1.5rem;
      color: var(--white);
      font-weight: 700;
    }
    nav {
      display: flex;
      gap: 2rem;
    }
    nav a {
      font-family: 'Fira Sans', sans-serif;
      text-decoration: none;
      color: var(--white);
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: all 0.3s ease;
      outline: 2px solid transparent;
    }
    nav a:hover, nav a:focus {
      background-color: var(--electric-blue);
      outline: 2px solid var(--neon-yellow);
    }
    nav a.active {
      background-color: var(--neon-yellow);
      color: var(--deep-blue);
      font-weight: 600;
    }
    /* NASA Space Apps: end */
    
    #selector {
      text-align: center;
      padding: 2rem;
      max-width: 1100px;
      margin: auto;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      margin-bottom: 1rem;
    }
    
    select {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      color: var(--white);
      margin: 0 0.5rem;
      font-weight: 500;
      transition: all 0.3s;
      font-family: 'Fira Sans', sans-serif;
    }
    select option {
      color: var(--electric-blue);
      background: white;
    }
    select:hover, select:focus {
      background: rgba(255,255,255,0.2);
      border-color: var(--neon-yellow);
      outline: 2px solid var(--neon-yellow);
    }
    
    #map, #windyContainer { 
      width: calc(100% - 4rem); 
      height: 75vh; 
      display: none;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      margin: 0 2rem;
      border: 2px solid rgba(255,255,255,0.2);
    }
    #windyContainer { text-align: center; }
    #map { display: block; }
    
    iframe { 
      width: 100%; 
      height: 75vh; 
      border: none; 
      border-radius: 15px;
    }
    
    .update-box { 
      position: absolute; 
      bottom: 20px; 
      left: 20px; 
      background: rgba(7,23,63,0.95);
      padding: 10px 15px;
      border-radius: 15px;
      font-size: 13px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 1000;
      color: var(--white);
      font-weight: 500;
      border: 1px solid var(--electric-blue);
    }
    
    #btnUbicacion {
      position: absolute; 
      bottom: 20px; 
      right: 20px; 
      z-index: 1000;
      background: var(--neon-yellow);
      color: var(--deep-blue);
      border: none;
      padding: 12px 18px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s;
      font-family: 'Fira Sans', sans-serif;
      outline: 2px solid transparent;
    }
    #btnUbicacion:hover, #btnUbicacion:focus { 
      background: var(--white);
      outline: 2px solid var(--neon-yellow);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    
    /* === L√çNEA DE TIEMPO === */
    #timeline {
      position: absolute;
      bottom: 20px;
      right: 160px;
      width: 250px;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      display: none;
    }
    #timeline h3 { 
      margin: 0 0 8px 0; 
      color: #2e7d32; 
      font-size: 14px;
      font-weight: 600;
    }
    #timeSlider {
      width: 100%;
      margin: 8px 0;
      accent-color: #2e7d32;
      height: 6px;
    }
    #timeInfo {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #5a4a00;
      font-weight: 500;
    }
    #playBtn {
      background: #4caf50;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #playBtn:hover { 
      background: #66bb6a;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    /* === PANEL UBICACI√ìN === */
    #userLocationPanel {
      position: absolute;
      top: 80px;
      left: 20px;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      font-size: 13px;
      max-width: 280px;
      display: none;
    }
    #userLocationPanel h4 { 
      margin: 0 0 8px 0; 
      color: #2e7d32;
      font-size: 16px;
      font-weight: 600;
    }
  </style>
</head>
<body>

  <!-- NASA Space Apps: start -->
  <header>
    <div class="logo">
      <!-- Place official NASA Space Apps logo here: /assets/space-apps-logo.svg -->
      <img src="/assets/space-apps-logo.svg" alt="NASA Space Apps Challenge" onerror="this.style.display='none'">
      <h1>EarthlyData</h1>
      <img src="logonasa.png" alt="NASA Logo" style="height: 40px; width: auto; margin-left: 1rem;">
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="mapa.html" class="active" aria-current="page">Map</a>
      <a href="mapa-plagas.html">Pest Map</a>
    </nav>
  </header>
  <!-- NASA Space Apps: end -->

<div id="selector">
  <label for="mapSelect"><b>Select map:</b></label>
  <select id="mapSelect" onchange="cambiarMapa()">
    <option value="floracion">üå∏ Flowering</option>
    <option value="floweringAdvanced">üåø Flowering Advanced (NDVI)</option>
    <option value="clima">üå¶Ô∏è Climate (Windy)</option>
  </select>

  <select id="layerSelect" onchange="cambiarCapaClima()" style="display:none;">
    <option value="temp">üå° Temperature</option>
    <option value="rh">üíß Relative Humidity</option>
    <option value="co">üß™ Carbon Monoxide (CO)</option>
    <option value="uvIndex">‚òÄÔ∏è UV Index</option>
  </select>

  <select id="filtroFloracion" onchange="filtrarFloracion()">
    <option value="todas">Show all</option>
    <option value="alta">üåø High flowering</option>
    <option value="baja">üçÇ Low flowering</option>
  </select>
  
  <select id="ndviDataset" onchange="cambiarDatasetNDVI()" style="display:none;">
    <option value="landsat" selected>Landsat 8/9</option>
    <option value="sentinel">Sentinel‚Äë2</option>
  </select>
  
  <input id="ndviSearch" type="text" placeholder="Search location..." style="display:none;" />
</div>

<div id="map"></div>
<div id="windyContainer">
  <iframe id="windyFrame" title="Windy embed"></iframe>
</div>

<div class="update-box">üîÑ Last update: <span id="lastUpdate">---</span></div>
<button id="btnUbicacion">üìç My location</button>

<!-- USER LOCATION PANEL -->
<div id="userLocationPanel">
  <h4>üìç Your Location</h4>
  <div id="locationInfo">Getting location...</div>
</div>

<!-- TIMELINE -->
<div id="timeline">
  <h3>üìÖ Timeline - Flowering</h3>
  <div id="timeInfo">
    <span id="currentDate">Noviembre 2024</span>
    <span>
      <button id="playBtn">‚ñ∂Ô∏è Play</button>
    </span>
  </div>
  <input type="range" id="timeSlider" min="0" max="11" value="0" step="1">
  <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px;">
    <span>Nov 2024</span>
    <span>Oct 2025</span>
  </div>
</div>

<!-- NDVI LEGEND -->
<div id="ndviLegend" style="position:absolute;bottom:20px;left:20px;background:rgba(7,23,63,0.95);color:white;padding:10px 15px;border-radius:15px;font-size:13px;box-shadow:0 4px 15px rgba(0,0,0,0.3);z-index:1000;border:1px solid #0042A6;display:none;min-width:260px;">
  <div><strong>NDVI ‚Üí Flowering Probability</strong></div>
  <div style="height:10px;width:100%;background:linear-gradient(90deg,#bd7c5d 0%,#bd7c5d 20%,#cca828 20%,#cca828 40%,#e2e90c 40%,#e2e90c 60%,#408b6d 60%,#408b6d 80%,#0a544a 80%,#0a544a 100%);border-radius:999px;margin:8px 0;"></div>
  <div style="display:flex;justify-content:space-between;opacity:0.9;"><span>Low</span><span>High</span></div>
  <div style="margin-top:8px;line-height:1.2;">
    <div><span style="display:inline-block;width:14px;height:10px;background:#bd7c5d;border-radius:2px;margin-right:6px;"></span><small>Very low (&lt; 0.20)</small></div>
    <div><span style="display:inline-block;width:14px;height:10px;background:#cca828;border-radius:2px;margin-right:6px;"></span><small>Low (0.20‚Äì0.40)</small></div>
    <div><span style="display:inline-block;width:14px;height:10px;background:#e2e90c;border-radius:2px;margin-right:6px;"></span><small>Medium (0.40‚Äì0.60)</small></div>
    <div><span style="display:inline-block;width:14px;height:10px;background:#408b6d;border-radius:2px;margin-right:6px;"></span><small>High (0.60‚Äì0.80)</small></div>
    <div><span style="display:inline-block;width:14px;height:10px;background:#0a544a;border-radius:2px;margin-right:6px;"></span><small>Very high (‚â• 0.80)</small></div>
  </div>
</div>

<script>
  // === MAPA LEAFLET ===
  const map = L.map('map').setView([10, 0], 2);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
  L.control.layers({ "üó∫Ô∏è Map": osm, "üõ∞Ô∏è Satellite": satelite }).addTo(map);

  // === CAPAS ===
  const capaFloracion = L.markerClusterGroup();
  const capaZonas = L.layerGroup().addTo(map);
  let marcadorUsuario = null;
  
  // === NDVI ADVANCED ===
  const NDVI_SERVICES = {
    landsat: 'https://landsat2.arcgis.com/arcgis/rest/services/Landsat8_Views/ImageServer',
    sentinel: 'https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer'
  };
  let ndviLayer = null;
  let ndviImageSvc = null;
  let ndviMarker = null;
  let currentNDVIDataset = 'landsat';

  // === L√çNEA DE TIEMPO ===
  const periodoCompleto = [
    { mes: 'November', a√±o: 2024, indice: 10 },
    { mes: 'December', a√±o: 2024, indice: 11 },
    { mes: 'January', a√±o: 2025, indice: 0 },
    { mes: 'February', a√±o: 2025, indice: 1 },
    { mes: 'March', a√±o: 2025, indice: 2 },
    { mes: 'April', a√±o: 2025, indice: 3 },
    { mes: 'May', a√±o: 2025, indice: 4 },
    { mes: 'June', a√±o: 2025, indice: 5 },
    { mes: 'July', a√±o: 2025, indice: 6 },
    { mes: 'August', a√±o: 2025, indice: 7 },
    { mes: 'September', a√±o: 2025, indice: 8 },
    { mes: 'October', a√±o: 2025, indice: 9 }
  ];
  const meses = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  let periodoActual = 0;
  let reproduciendo = false;
  let intervalId = null;
  let datosHistoricos = [];

  // === GENERAR DATOS HIST√ìRICOS ===
  function generarDatosHistoricos() {
    datosHistoricos = [];
    for (let i = 0; i < periodoCompleto.length; i++) {
      const periodo = periodoCompleto[i];
      const datosMes = [];
      for (let lat = -80; lat <= 80; lat += 5) {
        for (let lon = -180; lon <= 180; lon += 5) {
          const base = Math.max(0, 100 - Math.abs(lat));
          const variacionEstacional = Math.sin((periodo.indice / 12) * Math.PI * 2) * 20;
          const variacionLatitud = lat > 0 ? Math.cos((periodo.indice / 12) * Math.PI * 2) * 15 : Math.sin((periodo.indice / 12) * Math.PI * 2) * 15;
          // Agregar tendencia temporal (ligero aumento con el tiempo)
          const tendenciaTemporal = i * 2;
          const p = Math.min(100, Math.max(0, base + variacionEstacional + variacionLatitud + tendenciaTemporal + (Math.random() * 20 - 10)));
          datosMes.push({ lat, lon, valor: p });
        }
      }
      datosHistoricos.push(datosMes);
    }
  }

  // === GENERAR FLORACI√ìN GLOBAL ===
  function generarFloracion(indice = periodoActual) {
    capaFloracion.clearLayers();
    if (datosHistoricos.length === 0) generarDatosHistoricos();
    
    const datos = datosHistoricos[indice] || datosHistoricos[0];
    const periodo = periodoCompleto[indice] || periodoCompleto[0];
    
    datos.forEach(punto => {
      const color = punto.valor > 80 ? '#2ecc71' : punto.valor > 50 ? '#f1c40f' : punto.valor > 20 ? '#e67e22' : '#e74c3c';
      const marker = L.circleMarker([punto.lat, punto.lon], {
        radius: 5, fillColor: color, color: '#333',
        weight: 1, opacity: 1, fillOpacity: 0.8
      }).bindPopup(`<b>Floraci√≥n:</b> ${punto.valor.toFixed(1)}%<br><b>Per√≠odo:</b> ${periodo.mes} ${periodo.a√±o}`);
      capaFloracion.addLayer(marker);
    });
  }

  // === FUNCIONES L√çNEA DE TIEMPO ===
  function actualizarMapa(indice) {
    periodoActual = indice;
    generarFloracion(indice);
    const periodo = periodoCompleto[indice];
    document.getElementById('currentDate').textContent = `${periodo.mes} ${periodo.a√±o}`;
  }

  function reproducirTimeline() {
    if (reproduciendo) {
      clearInterval(intervalId);
      reproduciendo = false;
      document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Play';
    } else {
      reproduciendo = true;
      document.getElementById('playBtn').textContent = '‚è∏Ô∏è Pause';
      intervalId = setInterval(() => {
        periodoActual = (periodoActual + 1) % periodoCompleto.length;
        document.getElementById('timeSlider').value = periodoActual;
        actualizarMapa(periodoActual);
      }, 800);
    }
  }



  generarDatosHistoricos();
  generarFloracion();
  map.addLayer(capaFloracion);

  // === FILTRO FLORACI√ìN ===
  function filtrarFloracion() {
    const filtro = document.getElementById("filtroFloracion").value;
    capaZonas.clearLayers();
    capaFloracion.eachLayer(marker => {
      const popup = marker.getPopup();
      if (!popup) return;
      const match = popup.getContent().match(/([0-9.]+)%/);
      if (!match) return;
      const valor = parseFloat(match[1]);
      if (filtro === "alta" && valor > 75) {
        capaZonas.addLayer(L.circle(marker.getLatLng(), { radius: 200000, color: '#2ecc71', fillColor: '#2ecc71', fillOpacity: 0.3 }));
      } else if (filtro === "baja" && valor < 25) {
        capaZonas.addLayer(L.circle(marker.getLatLng(), { radius: 200000, color: '#e74c3c', fillColor: '#e74c3c', fillOpacity: 0.3 }));
      }
    });
  }

  // === CLIMA (WINDY) ===
  function cambiarCapaClima() {
    const overlay = document.getElementById('layerSelect').value;
    const iframe = document.getElementById('windyFrame');
    iframe.src = `https://embed.windy.com/embed2.html?lat=0&lon=0&zoom=2&level=surface&overlay=${overlay}&menu=true`;
  }

  function cambiarMapa() {
    const tipo = document.getElementById('mapSelect').value;
    const mapDiv = document.getElementById('map');
    const windyDiv = document.getElementById('windyContainer');
    const layerSelect = document.getElementById('layerSelect');
    const timeline = document.getElementById('timeline');
    const ndviDataset = document.getElementById('ndviDataset');
    const ndviSearch = document.getElementById('ndviSearch');
    const filtroFloracion = document.getElementById('filtroFloracion');

    // Reset visibility
    layerSelect.style.display = "none";
    timeline.style.display = "none";
    ndviDataset.style.display = "none";
    ndviSearch.style.display = "none";
    filtroFloracion.style.display = "inline-block";
    
    // Clear NDVI layer
    if (ndviLayer) {
      map.removeLayer(ndviLayer);
      ndviLayer = null;
    }

    if (tipo === "clima") {
      mapDiv.style.display = "none";
      windyDiv.style.display = "block";
      layerSelect.style.display = "inline-block";
      filtroFloracion.style.display = "none";
      cambiarCapaClima();
    } else if (tipo === "floweringAdvanced") {
      mapDiv.style.display = "block";
      windyDiv.style.display = "none";
      ndviDataset.style.display = "inline-block";
      ndviSearch.style.display = "inline-block";
      filtroFloracion.style.display = "none";
      map.removeLayer(capaFloracion);
      document.getElementById('ndviLegend').style.display = "block";
      inicializarNDVI();
      setTimeout(() => map.invalidateSize(), 200);
    } else {
      mapDiv.style.display = "block";
      windyDiv.style.display = "none";
      
      if (tipo === "floracion") {
        map.addLayer(capaFloracion);
        timeline.style.display = "block";
        document.getElementById('ndviLegend').style.display = "none";
      }
      setTimeout(() => map.invalidateSize(), 200);
    }
  }

  // === GEOLOCALIZACI√ìN ===
  let ubicacionUsuario = null;

  async function obtenerNombreCiudad(lat, lon) {
    try {
      const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=es`);
      const data = await response.json();
      return data.city || data.locality || data.principalSubdivision || 'Ubicaci√≥n desconocida';
    } catch (error) {
      return 'Ciudad no disponible';
    }
  }

  async function mostrarUbicacion(pos) {
    const { latitude, longitude, accuracy } = pos.coords;
    ubicacionUsuario = { lat: latitude, lon: longitude };
    
    // Agregar marcador
    if (marcadorUsuario) map.removeLayer(marcadorUsuario);
    marcadorUsuario = L.marker([latitude, longitude], {
      icon: L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png',
        iconSize: [35, 35],
        iconAnchor: [17, 35]
      })
    }).addTo(map);
    
    // Obtener nombre de la ciudad
    const ciudad = await obtenerNombreCiudad(latitude, longitude);
    
    // Actualizar popup del marcador
    marcadorUsuario.bindPopup(`
      <b>üìç Your actual ubication</b><br>
      <b>City:</b> ${ciudad}<br>
      <b>Coordinates:</b> ${latitude.toFixed(4)}, ${longitude.toFixed(4)}<br>
      <b>Precision:</b> ¬±${Math.round(accuracy)}m
    `).openPopup();
    
    // Mostrar panel de informaci√≥n
    const panel = document.getElementById('userLocationPanel');
    const info = document.getElementById('locationInfo');
    info.innerHTML = `
      <b>City</b> ${ciudad}<br>
      <b>Lat:</b> ${latitude.toFixed(4)}<br>
      <b>Lon:</b> ${longitude.toFixed(4)}<br>
      <b>Precision:</b> ¬±${Math.round(accuracy)}m
    `;
    panel.style.display = 'block';
    

    
    // Centrar mapa
    map.setView([latitude, longitude], 8);
  }

  function errorUbicacion(error) {
    const panel = document.getElementById('userLocationPanel');
    const info = document.getElementById('locationInfo');
    
    let mensaje = '';
    switch(error.code) {
      case error.PERMISSION_DENIED:
        mensaje = '‚ö†Ô∏è Permiso denegado. Habilita la geolocalizaci√≥n.';
        break;
      case error.POSITION_UNAVAILABLE:
        mensaje = '‚ö†Ô∏è Ubicaci√≥n no disponible.';
        break;
      case error.TIMEOUT:
        mensaje = '‚ö†Ô∏è Tiempo de espera agotado.';
        break;
      default:
        mensaje = '‚ö†Ô∏è Error desconocido.';
    }
    
    info.innerHTML = mensaje;
    panel.style.display = 'block';
    
    // Ocultar panel despu√©s de 5 segundos
    setTimeout(() => {
      panel.style.display = 'none';
    }, 5000);
  }

  function obtenerUbicacion() {
    if (navigator.geolocation) {
      const panel = document.getElementById('userLocationPanel');
      const info = document.getElementById('locationInfo');
      info.innerHTML = 'Obteniendo ubicaci√≥n...';
      panel.style.display = 'block';
      
      navigator.geolocation.getCurrentPosition(mostrarUbicacion, errorUbicacion, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000
      });
    } else {
      alert('Your browser does not support geolocation.');
    }
  }

  // Obtener ubicaci√≥n autom√°ticamente al cargar
  function obtenerUbicacionAutomatica() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        mostrarUbicacion,
        () => {}, // Error silencioso en carga autom√°tica
        { enableHighAccuracy: false, timeout: 5000, maximumAge: 600000 }
      );
    }
  }

  document.getElementById('btnUbicacion').addEventListener('click', obtenerUbicacion);

  // === EVENT LISTENERS L√çNEA DE TIEMPO ===
  document.getElementById('timeSlider').addEventListener('input', (e) => {
    actualizarMapa(parseInt(e.target.value));
  });

  document.getElementById('playBtn').addEventListener('click', reproducirTimeline);
  
  // === NDVI ADVANCED FUNCTIONS ===
  function inicializarNDVI() {
    if (!ndviImageSvc) {
      ndviImageSvc = L.esri.imageService({ url: NDVI_SERVICES[currentNDVIDataset] });
    }
    aplicarCapaNDVI();
    map.on('click', analizarNDVI);
  }
  
  function aplicarCapaNDVI() {
    if (ndviLayer) map.removeLayer(ndviLayer);
    
    const rfName = currentNDVIDataset === 'landsat' ? 'NDVI Colorized' : 'NDVI Colormap';
    
    ndviLayer = L.esri.imageMapLayer({
      url: NDVI_SERVICES[currentNDVIDataset],
      renderingRule: { rasterFunction: rfName },
      opacity: 0.8
    }).addTo(map);
  }
  
  async function analizarNDVI(e) {
    const latlng = e.latlng;
    
    if (ndviMarker) map.removeLayer(ndviMarker);
    ndviMarker = L.marker(latlng, { draggable: true }).addTo(map);
    
    try {
      const ndviValue = await obtenerNDVI(latlng);
      const prediction = predecirFloracionNDVI(latlng.lat, latlng.lng, ndviValue);
      
      const html = `
        <b>üåø Flowering Analysis (NDVI)</b><br>
        <b style="color:${prediction.color}">${prediction.label}</b><br>
        <small>NDVI: ${ndviValue?.toFixed(3) || 'n/a'}</small><br>
        <small>Confidence: ${prediction.confidence}</small><br>
        <small>${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}</small>
      `;
      
      ndviMarker.bindPopup(html).openPopup();
      ndviMarker.on('dragend', (ev) => analizarNDVI({latlng: ev.target.getLatLng()}));
      
    } catch (error) {
      console.error('Error analyzing NDVI:', error);
    }
  }
  
  function obtenerNDVI(latlng) {
    return new Promise((resolve) => {
      const timeout = setTimeout(() => resolve(null), 5000);
      
      ndviImageSvc.identify()
        .at(latlng)
        .setRenderingRule({ rasterFunction: 'NDVI Raw' })
        .run((err, res) => {
          clearTimeout(timeout);
          
          if (err || !res) {
            resolve(null);
            return;
          }
          
          let value = null;
          if (res.value !== undefined) value = Number(res.value);
          else if (res.pixel?.value !== undefined) value = Number(res.pixel.value);
          else if (res.values?.length) value = Number(res.values[0]);
          
          resolve(value !== null && !isNaN(value) ? Math.max(-1, Math.min(1, value)) : null);
        });
    });
  }
  
  function predecirFloracionNDVI(lat, lng, ndvi) {
    const absLat = Math.abs(lat);
    
    if (absLat > 80 || ndvi === null) {
      return { label: 'No data', color: '#7b8696', confidence: 'Low' };
    }
    
    let score = 0;
    let confidence = 'Low';
    
    if (ndvi > 0.7) {
      score = 0.9;
      confidence = 'Very High';
    } else if (ndvi > 0.5) {
      score = 0.7;
      confidence = 'High';
    } else if (ndvi > 0.3) {
      score = 0.5;
      confidence = 'Medium';
    } else if (ndvi > 0.1) {
      score = 0.3;
      confidence = 'Low';
    } else {
      score = 0.1;
      confidence = 'Very Low';
    }
    
    // Seasonal boost
    const month = new Date().getMonth();
    const isNorthern = lat > 0;
    const springMonths = isNorthern ? [2,3,4,5] : [8,9,10,11];
    if (springMonths.includes(month)) score *= 1.2;
    
    score = Math.min(1, score);
    
    if (score < 0.2) {
      return { label: 'Very low', color: '#bd7c5d', confidence };
    } else if (score < 0.4) {
      return { label: 'Low', color: '#cca828', confidence };
    } else if (score < 0.6) {
      return { label: 'Medium', color: '#e2e90c', confidence };
    } else if (score < 0.8) {
      return { label: 'High', color: '#408b6d', confidence };
    } else {
      return { label: 'Very high', color: '#0a544a', confidence };
    }
  }
  
  function cambiarDatasetNDVI() {
    currentNDVIDataset = document.getElementById('ndviDataset').value;
    ndviImageSvc = L.esri.imageService({ url: NDVI_SERVICES[currentNDVIDataset] });
    aplicarCapaNDVI();
  }
  
  // NDVI Search
  let searchTimeout;
  document.getElementById('ndviSearch').addEventListener('input', (e) => {
    const query = e.target.value.trim();
    if (query.length < 3) return;
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`
        );
        const results = await response.json();
        
        if (results.length > 0) {
          const result = results[0];
          const latlng = L.latLng(parseFloat(result.lat), parseFloat(result.lon));
          map.setView(latlng, 12);
          analizarNDVI({latlng});
        }
      } catch (error) {
        console.error('Search error:', error);
      }
    }, 500);
  });

  // === INICIALIZAR ===
  document.addEventListener('DOMContentLoaded', () => {
    // Establecer fecha actual (octubre 2025 = √≠ndice 11)
    const fechaActual = new Date();
    const mesActualReal = fechaActual.getMonth();
    const a√±oActual = fechaActual.getFullYear();
    
    // Encontrar el √≠ndice correspondiente al mes actual
    let indiceInicial = 11; // Por defecto octubre 2025
    for (let i = 0; i < periodoCompleto.length; i++) {
      const periodo = periodoCompleto[i];
      if (periodo.a√±o === a√±oActual && periodo.indice === mesActualReal) {
        indiceInicial = i;
        break;
      }
    }
    
    periodoActual = indiceInicial;
    document.getElementById('timeSlider').value = indiceInicial;
    actualizarMapa(indiceInicial);
    
    cambiarMapa();
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    
    // Obtener ubicaci√≥n autom√°ticamente (sin mostrar errores)
    setTimeout(obtenerUbicacionAutomatica, 1000);
  });
</script>

  <!-- NASA Space Apps: start -->
  <footer style="background: var(--deep-blue); color: var(--white); padding: 3rem 2rem 2rem; border-top: 2px solid var(--electric-blue); margin-top: 2rem;">
    <div style="max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 2rem; align-items: center;">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <img src="/assets/space-apps-logo.svg" alt="NASA Space Apps Challenge" style="height: 24px; width: auto;" onerror="this.style.display='none'">
      </div>
      <div style="text-align: center; font-size: 0.9rem;">
        <strong style="color: var(--neon-yellow);">Project for the NASA Space Apps Challenge 2025</strong><br>
        Science that blooms for a sustainable future
      </div>
      <div style="display: flex; justify-content: flex-end; gap: 1.5rem;">
        <a href="#privacy" style="color: var(--white); text-decoration: none; font-size: 0.9rem; transition: color 0.3s ease; outline: 2px solid transparent; padding: 0.25rem; border-radius: 4px;" onmouseover="this.style.color='var(--neon-yellow)'; this.style.outline='2px solid var(--neon-yellow)'" onmouseout="this.style.color='var(--white)'; this.style.outline='2px solid transparent'">Privacy</a>
        <a href="#contact" style="color: var(--white); text-decoration: none; font-size: 0.9rem; transition: color 0.3s ease; outline: 2px solid transparent; padding: 0.25rem; border-radius: 4px;" onmouseover="this.style.color='var(--neon-yellow)'; this.style.outline='2px solid var(--neon-yellow)'" onmouseout="this.style.color='var(--white)'; this.style.outline='2px solid transparent'">Contact</a>
      </div>
    </div>
  </footer>
  <!-- NASA Space Apps: end -->
</body>
</html>
