<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EarthlyData üåç Mapa Global</title>

  <!-- Leaflet y MarkerClusterx -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { background: linear-gradient(180deg, #fffde7 0%, #fff8e1 100%); color: #5a4a00; }
    header { display:flex; justify-content:space-between; align-items:center; padding:1.5rem 3rem; background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); position: sticky; top: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    header h1 { font-size: 1.8rem; color: #f9a825; font-weight: 700; }
    nav a { margin-left: 2rem; text-decoration: none; color: #f57f17; font-weight: 500; transition: color 0.3s; }
    nav a:hover { color: #fbc02d; }
    #selector { text-align: center; margin: 12px 0; padding: 0.5rem 1rem; }
    select { padding: 6px 10px; font-size: 15px; border-radius: 6px; margin: 0 6px; }
    #map, #windyContainer { width: 100%; height: 75vh; display: none; }
    #windyContainer { text-align: center; }
    #map { display: block; }
    iframe { width: 95%; height: 75vh; border: none; border-radius: 8px; }
    .update-box { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 6px 12px; border-radius: 8px; font-size: 13px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 1000; }
    #btnUbicacion {
      position: absolute; bottom: 20px; right: 20px; z-index: 1000;
      background: #fbc02d; color: #333; border: none; padding: 10px 14px;
      border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #btnUbicacion:hover { background: #f9a825; }
    
    /* === L√çNEA DE TIEMPO === */
    #timeline {
      position: absolute; bottom: 80px; left: 20px; right: 20px; z-index: 1000;
      background: rgba(255,255,255,0.95); padding: 15px; border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none;
    }
    #timeline h3 { margin: 0 0 10px 0; color: #f9a825; font-size: 16px; }
    #timeSlider {
      width: 100%; margin: 10px 0; accent-color: #f9a825;
    }
    #timeInfo {
      display: flex; justify-content: space-between; font-size: 14px; color: #666;
    }
    #playBtn {
      background: #2ecc71; color: white; border: none; padding: 8px 15px;
      border-radius: 5px; cursor: pointer; margin-left: 10px;
    }
    #playBtn:hover { background: #27ae60; }
    
    /* === PANEL UBICACI√ìN === */
    #userLocationPanel {
      position: absolute; top: 60px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,0.95); padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 12px; max-width: 250px;
      display: none;
    }
    #userLocationPanel h4 { margin: 0 0 5px 0; color: #f9a825; }
  </style>
</head>
<body>

<header>
  <h1>EarthlyData</h1>
  <nav>
    <a href="index.html">Inicio</a>
    <a href="mapa.html">Mapa</a>
    <a href="mapa-plagas.html">Mapa Plagas</a>
    <a href="#impacto">Informaci√≥n</a>
    <a href="#perfil">Perfil</a>
  </nav>
</header>

<div id="selector">
  <label for="mapSelect"><b>Selecciona mapa:</b></label>
  <select id="mapSelect" onchange="cambiarMapa()">
    <option value="floracion">üå∏ Floraci√≥n</option>
    <option value="clima">üå¶Ô∏è Clima (Windy)</option>
  </select>

  <select id="layerSelect" onchange="cambiarCapaClima()" style="display:none;">
    <option value="temp">üå° Temperatura</option>
    <option value="rh">üíß Humedad relativa</option>
    <option value="co">üß™ Mon√≥xido de carbono (CO)</option>
    <option value="uvIndex">‚òÄÔ∏è √çndice UV</option>
  </select>

  <select id="filtroFloracion" onchange="filtrarFloracion()">
    <option value="todas">Mostrar todas</option>
    <option value="alta">üåø Alta floraci√≥n</option>
    <option value="baja">üçÇ Baja floraci√≥n</option>
  </select>
</div>

<div id="map"></div>
<div id="windyContainer">
  <iframe id="windyFrame" title="Windy embed"></iframe>
</div>

<div class="update-box">üîÑ √öltima actualizaci√≥n: <span id="lastUpdate">---</span></div>
<button id="btnUbicacion">üìç Mi ubicaci√≥n</button>

<!-- PANEL UBICACI√ìN USUARIO -->
<div id="userLocationPanel">
  <h4>üìç Tu Ubicaci√≥n</h4>
  <div id="locationInfo">Obteniendo ubicaci√≥n...</div>
</div>

<!-- L√çNEA DE TIEMPO -->
<div id="timeline">
  <h3>üìÖ L√≠nea de Tiempo - Floraci√≥n</h3>
  <div id="timeInfo">
    <span id="currentDate">Enero 2024</span>
    <span>
      <button id="playBtn">‚ñ∂Ô∏è Reproducir</button>
    </span>
  </div>
  <input type="range" id="timeSlider" min="0" max="11" value="0" step="1">
  <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px;">
    <span>Ene 2024</span>
    <span>Dic 2024</span>
  </div>
</div>

<script>
  // === MAPA LEAFLET ===
  const map = L.map('map').setView([10, 0], 2);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
  L.control.layers({ "üó∫Ô∏è Mapa": osm, "üõ∞Ô∏è Sat√©lite": satelite }).addTo(map);

  // === CAPAS ===
  const capaFloracion = L.markerClusterGroup();
  const capaZonas = L.layerGroup().addTo(map);
  let marcadorUsuario = null;

  // === L√çNEA DE TIEMPO ===
  const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
  let mesActual = 0;
  let reproduciendo = false;
  let intervalId = null;
  let datosHistoricos = [];

  // === GENERAR DATOS HIST√ìRICOS ===
  function generarDatosHistoricos() {
    datosHistoricos = [];
    for (let mes = 0; mes < 12; mes++) {
      const datosMes = [];
      for (let lat = -80; lat <= 80; lat += 5) {
        for (let lon = -180; lon <= 180; lon += 5) {
          const base = Math.max(0, 100 - Math.abs(lat));
          const variacionEstacional = Math.sin((mes / 12) * Math.PI * 2) * 20;
          const variacionLatitud = lat > 0 ? Math.cos((mes / 12) * Math.PI * 2) * 15 : Math.sin((mes / 12) * Math.PI * 2) * 15;
          const p = Math.min(100, Math.max(0, base + variacionEstacional + variacionLatitud + (Math.random() * 20 - 10)));
          datosMes.push({ lat, lon, valor: p });
        }
      }
      datosHistoricos.push(datosMes);
    }
  }

  // === GENERAR FLORACI√ìN GLOBAL ===
  function generarFloracion(mes = mesActual) {
    capaFloracion.clearLayers();
    if (datosHistoricos.length === 0) generarDatosHistoricos();
    
    const datos = datosHistoricos[mes] || datosHistoricos[0];
    datos.forEach(punto => {
      const color = punto.valor > 80 ? '#2ecc71' : punto.valor > 50 ? '#f1c40f' : punto.valor > 20 ? '#e67e22' : '#e74c3c';
      const marker = L.circleMarker([punto.lat, punto.lon], {
        radius: 5, fillColor: color, color: '#333',
        weight: 1, opacity: 1, fillOpacity: 0.8
      }).bindPopup(`<b>Floraci√≥n:</b> ${punto.valor.toFixed(1)}%<br><b>Mes:</b> ${meses[mes]} 2024`);
      capaFloracion.addLayer(marker);
    });
  }

  // === FUNCIONES L√çNEA DE TIEMPO ===
  function actualizarMapa(mes) {
    mesActual = mes;
    generarFloracion(mes);
    document.getElementById('currentDate').textContent = `${meses[mes]} 2024`;
  }

  function reproducirTimeline() {
    if (reproduciendo) {
      clearInterval(intervalId);
      reproduciendo = false;
      document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Reproducir';
    } else {
      reproduciendo = true;
      document.getElementById('playBtn').textContent = '‚è∏Ô∏è Pausar';
      intervalId = setInterval(() => {
        mesActual = (mesActual + 1) % 12;
        document.getElementById('timeSlider').value = mesActual;
        actualizarMapa(mesActual);
      }, 800);
    }
  }



  generarDatosHistoricos();
  generarFloracion();
  map.addLayer(capaFloracion);

  // === FILTRO FLORACI√ìN ===
  function filtrarFloracion() {
    const filtro = document.getElementById("filtroFloracion").value;
    capaZonas.clearLayers();
    capaFloracion.eachLayer(marker => {
      const popup = marker.getPopup();
      if (!popup) return;
      const match = popup.getContent().match(/([0-9.]+)%/);
      if (!match) return;
      const valor = parseFloat(match[1]);
      if (filtro === "alta" && valor > 75) {
        capaZonas.addLayer(L.circle(marker.getLatLng(), { radius: 200000, color: '#2ecc71', fillColor: '#2ecc71', fillOpacity: 0.3 }));
      } else if (filtro === "baja" && valor < 25) {
        capaZonas.addLayer(L.circle(marker.getLatLng(), { radius: 200000, color: '#e74c3c', fillColor: '#e74c3c', fillOpacity: 0.3 }));
      }
    });
  }

  // === CLIMA (WINDY) ===
  function cambiarCapaClima() {
    const overlay = document.getElementById('layerSelect').value;
    const iframe = document.getElementById('windyFrame');
    iframe.src = `https://embed.windy.com/embed2.html?lat=0&lon=0&zoom=2&level=surface&overlay=${overlay}&menu=true`;
  }

  function cambiarMapa() {
    const tipo = document.getElementById('mapSelect').value;
    const mapDiv = document.getElementById('map');
    const windyDiv = document.getElementById('windyContainer');
    const layerSelect = document.getElementById('layerSelect');
    const timeline = document.getElementById('timeline');

    if (tipo === "clima") {
      mapDiv.style.display = "none";
      windyDiv.style.display = "block";
      layerSelect.style.display = "inline-block";
      timeline.style.display = "none";
      cambiarCapaClima();
    } else {
      mapDiv.style.display = "block";
      windyDiv.style.display = "none";
      layerSelect.style.display = "none";
      
      if (tipo === "floracion") {
        map.addLayer(capaFloracion);
        timeline.style.display = "block";
      }
      setTimeout(() => map.invalidateSize(), 200);
    }
  }

  // === GEOLOCALIZACI√ìN ===
  let ubicacionUsuario = null;

  async function obtenerNombreCiudad(lat, lon) {
    try {
      const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=es`);
      const data = await response.json();
      return data.city || data.locality || data.principalSubdivision || 'Ubicaci√≥n desconocida';
    } catch (error) {
      return 'Ciudad no disponible';
    }
  }

  async function mostrarUbicacion(pos) {
    const { latitude, longitude, accuracy } = pos.coords;
    ubicacionUsuario = { lat: latitude, lon: longitude };
    
    // Agregar marcador
    if (marcadorUsuario) map.removeLayer(marcadorUsuario);
    marcadorUsuario = L.marker([latitude, longitude], {
      icon: L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png',
        iconSize: [35, 35],
        iconAnchor: [17, 35]
      })
    }).addTo(map);
    
    // Obtener nombre de la ciudad
    const ciudad = await obtenerNombreCiudad(latitude, longitude);
    
    // Actualizar popup del marcador
    marcadorUsuario.bindPopup(`
      <b>üìç Tu ubicaci√≥n actual</b><br>
      <b>Ciudad:</b> ${ciudad}<br>
      <b>Coordenadas:</b> ${latitude.toFixed(4)}, ${longitude.toFixed(4)}<br>
      <b>Precisi√≥n:</b> ¬±${Math.round(accuracy)}m
    `).openPopup();
    
    // Mostrar panel de informaci√≥n
    const panel = document.getElementById('userLocationPanel');
    const info = document.getElementById('locationInfo');
    info.innerHTML = `
      <b>Ciudad:</b> ${ciudad}<br>
      <b>Lat:</b> ${latitude.toFixed(4)}<br>
      <b>Lon:</b> ${longitude.toFixed(4)}<br>
      <b>Precisi√≥n:</b> ¬±${Math.round(accuracy)}m
    `;
    panel.style.display = 'block';
    

    
    // Centrar mapa
    map.setView([latitude, longitude], 8);
  }

  function errorUbicacion(error) {
    const panel = document.getElementById('userLocationPanel');
    const info = document.getElementById('locationInfo');
    
    let mensaje = '';
    switch(error.code) {
      case error.PERMISSION_DENIED:
        mensaje = '‚ö†Ô∏è Permiso denegado. Habilita la geolocalizaci√≥n.';
        break;
      case error.POSITION_UNAVAILABLE:
        mensaje = '‚ö†Ô∏è Ubicaci√≥n no disponible.';
        break;
      case error.TIMEOUT:
        mensaje = '‚ö†Ô∏è Tiempo de espera agotado.';
        break;
      default:
        mensaje = '‚ö†Ô∏è Error desconocido.';
    }
    
    info.innerHTML = mensaje;
    panel.style.display = 'block';
    
    // Ocultar panel despu√©s de 5 segundos
    setTimeout(() => {
      panel.style.display = 'none';
    }, 5000);
  }

  function obtenerUbicacion() {
    if (navigator.geolocation) {
      const panel = document.getElementById('userLocationPanel');
      const info = document.getElementById('locationInfo');
      info.innerHTML = 'Obteniendo ubicaci√≥n...';
      panel.style.display = 'block';
      
      navigator.geolocation.getCurrentPosition(mostrarUbicacion, errorUbicacion, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000
      });
    } else {
      alert('Tu navegador no soporta geolocalizaci√≥n.');
    }
  }

  // Obtener ubicaci√≥n autom√°ticamente al cargar
  function obtenerUbicacionAutomatica() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        mostrarUbicacion,
        () => {}, // Error silencioso en carga autom√°tica
        { enableHighAccuracy: false, timeout: 5000, maximumAge: 600000 }
      );
    }
  }

  document.getElementById('btnUbicacion').addEventListener('click', obtenerUbicacion);

  // === EVENT LISTENERS L√çNEA DE TIEMPO ===
  document.getElementById('timeSlider').addEventListener('input', (e) => {
    actualizarMapa(parseInt(e.target.value));
  });

  document.getElementById('playBtn').addEventListener('click', reproducirTimeline);

  // === INICIALIZAR ===
  document.addEventListener('DOMContentLoaded', () => {
    cambiarMapa();
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    
    // Obtener ubicaci√≥n autom√°ticamente (sin mostrar errores)
    setTimeout(obtenerUbicacionAutomatica, 1000);
  });
</script>
</body>
</html>
