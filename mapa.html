<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa Global - Floraci√≥n, Plagas y Clima con UV</title>

  <!-- Leaflet y MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { background: linear-gradient(180deg, #fffde7 0%, #fff8e1 100%); color: #5a4a00; }
    header { display:flex; justify-content:space-between; align-items:center; padding:1.5rem 3rem; background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); position: sticky; top: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    header h1 { font-size: 1.8rem; color: #f9a825; font-weight: 700; }
    nav a { margin-left: 2rem; text-decoration: none; color: #f57f17; font-weight: 500; transition: color 0.3s; }
    nav a:hover { color: #fbc02d; }
    #selector { text-align: center; margin: 12px 0; padding: 0.5rem 1rem; }
    select { padding: 6px 10px; font-size: 15px; border-radius: 6px; margin: 0 6px; }
    #map, #windyContainer { 
      width: 100%; 
      height: 75vh; 
      display: none; 
    }
    #windyContainer { 
      text-align: center; 
    }
    #map {
      display: block;
    }
    iframe { 
      width: 95%; 
      height: 75vh; 
      border: none; 
      border-radius: 8px; 
    }
    .update-box { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 6px 12px; border-radius: 8px; font-size: 13px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 1000; }
    

  </style>
</head>
<body>

<header>
  <h1>EarthlyData</h1>
  <nav>
    <a href="index.html">Inicio</a>
    <a href="mapa.html">Mapa</a>
      <a href="#impacto">Informaci√≥n</a>
    <a href="#impacto">Perfil</a>
  </nav>
</header>

<div id="selector">
  <label for="mapSelect"><b>Selecciona mapa:</b></label>
  <select id="mapSelect" onchange="cambiarMapa()">
    <option value="floracion">üå∏ Floraci√≥n</option>
    <option value="plagas">üêõ Plagas</option>
    <option value="clima">üå¶Ô∏è Clima (Windy)</option>
  </select>

  <select id="layerSelect" onchange="cambiarCapaClima()" style="display:none;">
    <option value="temp">üå° Temperatura</option>
    <option value="rh">üíß Humedad relativa</option>
    <option value="co">üß™ Mon√≥xido de carbono (CO)</option>
    <option value="uvIndex">‚òÄÔ∏è √çndice UV</option>
  </select>

  <!-- Filtro de floraci√≥n -->
  <select id="filtroFloracion" onchange="filtrarFloracion()">
    <option value="todas">Mostrar todas</option>
    <option value="alta">üåø Alta floraci√≥n</option>
    <option value="baja">üçÇ Baja floraci√≥n</option>
  </select>
</div>

<!-- Timeline controls -->
<div id="timeline" style="text-align:center; padding:0.5rem 1rem; background:rgba(255,255,255,0.9);">
  <button id="playBtn" style="padding:6px 10px; margin-right:8px;">‚ñ∂Ô∏è</button>
  <input type="range" id="timeRange" min="0" max="11" value="11" style="width:50%; vertical-align:middle;">
  <span id="timeLabel" style="margin-left:8px; font-weight:600;"></span>
</div>

<div id="map"></div>



<div id="windyContainer">
  <iframe id="windyFrame" title="Windy embed"></iframe>
</div>

<div class="update-box">üîÑ √öltima actualizaci√≥n: <span id="lastUpdate">---</span></div>

<script>
  // === MAPA LEAFLET ===
  const map = L.map('map').setView([10, 0], 2); // Vista global

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const satelite = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution: '&copy; Esri, Maxar, Earthstar Geographics' }
  );

  L.control.layers({ "üó∫Ô∏è Mapa": osm, "üõ∞Ô∏è Sat√©lite": satelite }).addTo(map);

  // === CAPAS ===
  const capaFloracion = L.markerClusterGroup();
  const capaPlagas = L.markerClusterGroup();
  const capaZonas = L.layerGroup().addTo(map); // Para resaltar regiones

  // === TIMELINE (√∫ltimos 12 meses) ===
  const MONTHS = 12;
  const now = new Date();
  const timeSteps = [];
  for (let i = MONTHS - 1; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    timeSteps.push(d);
  }

  // cache de datos por paso temporal
  const floracionCache = {}; // index -> array of {lat,lon,p}
  let plagasData = []; // {lat, lon, plaga, cultivo, fecha: Date}

  // generar plagas con fecha aleatoria en el √∫ltimo a√±o
  (function generarPlagasHistoricas() {
    plagasData = [];
    for (let i = 0; i < 200; i++) {
      const lat = (Math.random() * 160) - 80;
      const lon = (Math.random() * 360) - 180;
      const plagas = ["Pulg√≥n verde", "Mosca blanca", "Oruga", "Langosta", "Trips", "Escarabajo"];
      const cultivos = ["Trigo", "Ma√≠z", "C√≠tricos", "Soja", "Algod√≥n", "Papa"];
      const plaga = plagas[Math.floor(Math.random() * plagas.length)];
      const cultivo = cultivos[Math.floor(Math.random() * cultivos.length)];
      // fecha aleatoria en el rango de timeSteps
      const offset = Math.floor(Math.random() * MONTHS);
      const fecha = new Date(timeSteps[offset].getFullYear(), timeSteps[offset].getMonth(), 1 + Math.floor(Math.random() * 27));
      plagasData.push({ lat, lon, plaga, cultivo, fecha });
    }
  })();

  function colorFloracion(p) {
    return p > 80 ? '#2ecc71' :
           p > 50 ? '#f1c40f' :
           p > 20 ? '#e67e22' : '#e74c3c';
  }

  // genera (y cachea) datos de floraci√≥n para un paso temporal dado (index)
  function getFloracionForStep(index) {
    if (floracionCache[index]) return floracionCache[index];
    const data = [];
    // uso paso de 10 grados para rendimiento
    for (let lat = -80; lat <= 80; lat += 10) {
      for (let lon = -180; lon <= 180; lon += 10) {
        // variaci√≥n temporal: oscila con el √≠ndice
        const seasonal = 20 * Math.sin((index / MONTHS) * Math.PI * 2 + (lat / 90));
        const base = Math.max(0, 100 - Math.abs(lat));
        const noise = (Math.random() * 20 - 10);
        const p = Math.min(100, Math.max(0, base + seasonal + noise));
        data.push({ lat, lon, p });
      }
    }
    floracionCache[index] = data;
    return data;
  }

  // renderizar floraci√≥n y plagas para un paso
  function renderStep(index) {
    capaFloracion.clearLayers();
    capaPlagas.clearLayers();
    capaZonas.clearLayers();

    const data = getFloracionForStep(index);
    data.forEach(d => {
      const color = colorFloracion(d.p);
      const marker = L.circleMarker([d.lat, d.lon], {
        radius: 5, fillColor: color, color: '#333', weight: 1, opacity: 1, fillOpacity: 0.8
      }).bindPopup(`<b>Floraci√≥n estimada:</b> ${d.p.toFixed(1)}%<br><b>Lat:</b> ${d.lat}, <b>Lon:</b> ${d.lon}`);
      capaFloracion.addLayer(marker);
    });

    // mostrar plagas cuyo mes/a√±o coincida con el paso
    const stepDate = timeSteps[index];
    plagasData.filter(p => p.fecha.getFullYear() === stepDate.getFullYear() && p.fecha.getMonth() === stepDate.getMonth())
      .forEach(p => {
        const marker = L.circleMarker([p.lat, p.lon], { radius: 7, fillColor: 'red', color: '#800', weight:1, opacity:1, fillOpacity:0.9 })
          .bindPopup(`<b>Plaga:</b> ${p.plaga}<br><b>Cultivo:</b> ${p.cultivo}<br><b>Fecha:</b> ${p.fecha.toISOString().split('T')[0]}`);
        capaPlagas.addLayer(marker);
      });

    // aplicar filtro de floraci√≥n (resaltar zonas) si corresponde
    filtrarFloracion();

    // a√±adir capas si no est√°n
    if (!map.hasLayer(capaFloracion)) map.addLayer(capaFloracion);
    if (!map.hasLayer(capaPlagas)) map.addLayer(capaPlagas);
  }

  // filtrar floraci√≥n en la capaZonas usando los datos actualmente renderizados
  function filtrarFloracion() {
    const filtro = document.getElementById("filtroFloracion").value;
    capaZonas.clearLayers();
    if (filtro === "todas") return;
    // tomamos los markers actuales en capaFloracion (iterable)
    capaFloracion.eachLayer(m => {
      // extraemos porcentaje desde el popup content (no ideal pero suficiente)
      const popup = m.getPopup && m.getPopup();
      if (!popup) return;
      const txt = popup.getContent();
      const match = txt.match(/([0-9]+\.[0-9]+|[0-9]+)%/);
      if (!match) return;
      const p = parseFloat(match[1]);
      const meets = filtro === 'alta' ? p > 75 : p < 25;
      if (meets) {
        const circle = L.circle(m.getLatLng(), { radius: 200000, color: filtro === 'alta' ? '#2ecc71' : '#e74c3c', fillColor: filtro === 'alta' ? '#2ecc71' : '#e74c3c', fillOpacity: 0.25 });
        capaZonas.addLayer(circle);
      }
    });
  }

  // timeline UI
  const timeRange = document.getElementById('timeRange');
  const timeLabel = document.getElementById('timeLabel');
  const playBtn = document.getElementById('playBtn');
  let playInterval = null;

  function updateTimeLabel(index) {
    const d = timeSteps[index];
    const fmt = d.toLocaleString('es-ES', { year: 'numeric', month: 'short' });
    timeLabel.textContent = fmt;
  }

  // inicializar control
  timeRange.max = timeSteps.length - 1;
  timeRange.value = timeSteps.length - 1; // mostrar m√°s reciente
  updateTimeLabel(timeRange.value);

  timeRange.addEventListener('input', e => {
    const idx = parseInt(e.target.value, 10);
    renderStep(idx);
    updateTimeLabel(idx);
  });

  playBtn.addEventListener('click', () => {
    if (playInterval) {
      clearInterval(playInterval); playInterval = null; playBtn.textContent = '‚ñ∂Ô∏è';
    } else {
      playBtn.textContent = '‚è∏Ô∏è';
      playInterval = setInterval(() => {
        let idx = parseInt(timeRange.value, 10);
        idx = Math.min(timeSteps.length - 1, idx + 1);
        timeRange.value = idx;
        updateTimeLabel(idx);
        renderStep(idx);
        if (idx === timeSteps.length - 1) { clearInterval(playInterval); playInterval = null; playBtn.textContent = '‚ñ∂Ô∏è'; }
      }, 800);
    }
  });

  // Inicializar: renderizar el paso m√°s reciente
  renderStep(timeSteps.length - 1);

  // actualizar datos cada minuto (solo regenerar√° si cambias manualmente)
  setInterval(() => {
    // limpieza de cache peque√±a para permitir variaci√≥n en regeneraciones
    for (const k in floracionCache) delete floracionCache[k];
    renderStep(parseInt(timeRange.value, 10));
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
  }, 60000);

  // === CLIMA (WINDY) ===
  function cambiarCapaClima() {
    const overlay = document.getElementById('layerSelect').value || 'temp';
    const iframe = document.getElementById('windyFrame');
    iframe.src = `https://embed.windy.com/embed2.html?lat=0&lon=0&zoom=2&level=surface&overlay=${overlay}&menu=true&message=true&calendar=now&pressure=true&type=map&location=coordinates`;
  }

  // mantener comportamiento previo para selector
  function cambiarMapa() {
    const tipo = document.getElementById('mapSelect').value;
    const mapDiv = document.getElementById('map');
    const windyDiv = document.getElementById('windyContainer');
    const layerSelect = document.getElementById('layerSelect');

    // Ocultar todos los elementos
    [mapDiv, windyDiv].forEach(div => div.style.display = "none");
    layerSelect.style.display = "none";

    // Mostrar el panel correspondiente seg√∫n la selecci√≥n
    switch(tipo) {
      case "clima":
        windyDiv.style.display = "block";
        layerSelect.style.display = "inline-block";
        cambiarCapaClima();
        break;
      default:
        mapDiv.style.display = "block";
        if (tipo === "floracion") {
          if (!map.hasLayer(capaFloracion)) map.addLayer(capaFloracion);
          map.removeLayer(capaPlagas);
        } else if (tipo === "plagas") {
          if (!map.hasLayer(capaPlagas)) map.addLayer(capaPlagas);
          map.removeLayer(capaFloracion);
        }
        setTimeout(() => map.invalidateSize(), 200);
    }
  }



  // Inicializar vista correcta seg√∫n selector
  document.addEventListener('DOMContentLoaded', () => {
    cambiarMapa();
  });
</script>
</body>
</html>

